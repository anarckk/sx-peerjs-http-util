<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerJS HTTP Server Test</title>
  <script src="../dist/index.umd.js"></script>
</head>
<body>
  <h1>PeerJS HTTP Server</h1>
  <div id="peer-id">Connecting...</div>
  <div id="log"></div>

  <script>
    const serverConfig = {
      host: 'localhost',
      port: 9000,
      path: '/peerjs',
      secure: false
    };

    const wrapper = new PeerJsHttpUtil.PeerJsWrapper(undefined, false, serverConfig);

    wrapper.registerHandler('/api/hello', (from, data) => {
      return { message: 'Hello from server', received: data };
    });

    wrapper.registerHandler('/api/echo', (from, data) => data);

    wrapper.registerHandler('/api/error', (from) => {
      throw new Error('Test error from server');
    });

    // 测试 from 参数的处理器
    wrapper.registerHandler('/api/whoami', (from, data) => {
      return { yourPeerId: from };
    });

    window.testWrapper = wrapper;
    window.peerReady = false;
    window.peerId = null;

    wrapper.whenReady().then(() => {
      const id = wrapper.getPeerId();
      window.peerReady = true;
      window.peerId = id;
      document.getElementById('peer-id').textContent = `Peer ID: ${id}`;
      if (window.getServerPeerId) window.getServerPeerId(id);
      log('Peer connected with ID: ' + id);
    }).catch((err) => {
      log('Peer error: ' + err.message);
    });

    function log(message) {
      const logDiv = document.getElementById('log');
      const p = document.createElement('p');
      p.textContent = new Date().toISOString() + ' - ' + message;
      logDiv.appendChild(p);
    }
  </script>
</body>
</html>
