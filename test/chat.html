<!--
  P2P Chat - 基于 sx-peerjs-http-util 的即时聊天工具

  功能特性：
  1. P2P 即时聊天 - 基于 WebRTC 的点对点通信，无需服务器中转消息
  2. 多会话支持 - 可以同时与多个 Peer ID 建立聊天
  3. 消息持久化 - 聊天记录存储在 IndexedDB，刷新页面后依然保留
  4. Peer ID 持久化 - 自己的 Peer ID 存储在 localStorage，刷新后不变
  5. 文件传输 - 支持图片、视频、任意类型文件传输
  6. 大文件支持 - 100MB 以上文件自动分片传输，无文件大小上限
  7. 视频流式播放 - 大视频支持边下载边播放
  8. 语音/视频通话 - 支持实时语音和视频通话

  使用方法：
  1. 启动 HTTP 服务器：npx serve -l 8080
  2. 打开浏览器访问：http://localhost:8080/test/chat.html
  3. 在两个浏览器窗口（或不同设备）分别打开该页面
  4. 复制一方的 Peer ID，在另一方粘贴并回车，即可建立聊天
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Chat</title>
  <link rel="stylesheet" href="./chat.css">
  <script src="https://unpkg.com/sx-peerjs-http-util/dist/index.umd.js"></script>
</head>
<body>
  <div class="header">
    <div style="font-size: 18px; font-weight: 500; display: flex; align-items: center;">
      <button class="back-btn" id="backBtn" title="Back to contacts">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      P2P Chat
    </div>
    <div class="my-id">My ID: <span id="myPeerId" title="Click to copy">Loading...</span></div>
  </div>
  <div id="status" class="status">Connecting...</div>
  <div class="main">
    <div class="sidebar">
      <div class="add-contact">
        <input type="text" id="newPeerId" placeholder="Enter peer ID to chat...">
      </div>
      <div class="contact-list" id="contactList"></div>
    </div>
    <div class="chat-area" id="chatArea">
      <div class="empty-state">Select a contact to start chatting</div>
    </div>
  </div>

  <!-- 通话界面 -->
  <div class="call-overlay" id="callOverlay">
    <div class="call-video-container">
      <div class="call-status" id="callStatus">Calling...</div>
      <div class="call-peer-id" id="callPeerId"></div>
      <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
      <video class="local-video" id="localVideo" autoplay playsinline muted></video>
      <div class="audio-only-indicator" id="audioOnlyIndicator" style="display:none;">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
      </div>
      <div class="call-controls">
        <button class="mute" id="muteBtn" title="Mute">
          <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
        </button>
        <button class="hangup" id="hangupBtn" title="Hang Up">
          <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- 来电提示 -->
  <div class="overlay-bg" id="overlayBg"></div>
  <div class="incoming-call-modal" id="incomingCallModal">
    <h3>Incoming Call</h3>
    <div class="caller-id" id="callerId"></div>
    <div class="call-type" id="callType">Voice Call</div>
    <div class="incoming-call-actions">
      <button class="reject" id="rejectCallBtn" title="Reject">
        <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
      </button>
      <button class="accept" id="acceptCallBtn" title="Accept">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
      </button>
    </div>
  </div>

  <script type="module" src="./chat.js"></script>
</body>
</html>
