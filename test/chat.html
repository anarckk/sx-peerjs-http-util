<!--
  P2P Chat - 基于 sx-peerjs-http-util 的即时聊天工具

  功能特性：
  1. P2P 即时聊天 - 基于 WebRTC 的点对点通信，无需服务器中转消息
  2. 多会话支持 - 可以同时与多个 Peer ID 建立聊天
  3. 消息持久化 - 聊天记录存储在 IndexedDB，刷新页面后依然保留
  4. Peer ID 持久化 - 自己的 Peer ID 存储在 localStorage，刷新后不变
  5. 文件传输 - 支持图片、视频、任意类型文件传输
  6. 大文件支持 - 100MB 以上文件自动分片传输，无文件大小上限
  7. 视频流式播放 - 大视频支持边下载边播放

  使用方法：
  1. 启动 HTTP 服务器：npx serve -l 8080
  2. 打开浏览器访问：http://localhost:8080/test/chat.html
  3. 在两个浏览器窗口（或不同设备）分别打开该页面
  4. 复制一方的 Peer ID，在另一方粘贴并回车，即可建立聊天

  技术栈：
  - sx-peerjs-http-util (CDN) - P2P 通信库
  - IndexedDB - 消息、联系人、文件持久化
  - localStorage - Peer ID 持久化
  - MediaSource API - 视频流式播放
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Chat</title>
  <script src="https://unpkg.com/sx-peerjs-http-util/dist/index.umd.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f5f5f5;
    }
    .header {
      background: #4a90d9;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header .my-id {
      font-size: 13px;
      opacity: 0.9;
    }
    .header .my-id span {
      font-family: monospace;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
      cursor: pointer;
    }
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .sidebar {
      width: 260px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }
    .add-contact {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    .add-contact input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .add-contact input:focus {
      outline: none;
      border-color: #4a90d9;
    }
    .contact-list {
      flex: 1;
      overflow-y: auto;
    }
    .contact-item {
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .contact-item:hover { background: #f8f8f8; }
    .contact-item.active { background: #e8f0fe; }
    .contact-item .peer-id {
      font-size: 13px;
      font-family: monospace;
      color: #333;
    }
    .contact-item .delete-btn {
      color: #999;
      cursor: pointer;
      font-size: 18px;
      opacity: 0;
      pointer-events: none;
    }
    .contact-item:hover .delete-btn { opacity: 1; pointer-events: auto; }
    .contact-item .delete-btn:hover { color: #e74c3c; }
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f9f9f9;
    }
    .chat-header {
      padding: 14px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      font-size: 14px;
      color: #666;
    }
    .chat-header span { font-family: monospace; color: #333; }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .message {
      margin-bottom: 12px;
      display: flex;
    }
    .message.sent { justify-content: flex-end; }
    .message.received { justify-content: flex-start; }
    .message > div {
      max-width: 70%;
    }
    .message .bubble {
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      word-break: break-word;
    }
    .message.sent .bubble {
      background: #4a90d9;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.received .bubble {
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    .message .time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }
    .message.sent .time { text-align: right; }
    .message.received .time { text-align: left; }
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
    }
    .input-area {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-area input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
    }
    .input-area input:focus {
      outline: none;
      border-color: #4a90d9;
    }
    .input-area button {
      padding: 12px 24px;
      background: #4a90d9;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    .input-area button:hover { background: #3a7bc8; }
    .input-area button:disabled { background: #ccc; cursor: not-allowed; }
    .status {
      font-size: 12px;
      padding: 8px 20px;
      background: #fff3cd;
      color: #856404;
    }
    .status.connected { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }

    /* 通话按钮样式 */
    .call-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .call-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .call-btn:hover { background: rgba(0,0,0,0.1); }
    .call-btn svg { width: 20px; height: 20px; }
    .call-btn.voice svg { fill: #4a90d9; }
    .call-btn.video svg { fill: #4a90d9; }
    .call-btn.hangup svg { fill: #e74c3c; }

    /* 通话界面 */
    .call-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #1a1a1a;
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    .call-overlay.active { display: flex; }
    .call-overlay.calling {
      align-items: center;
      justify-content: center;
    }
    .call-overlay.connected {
      align-items: center;
      justify-content: flex-start;
      padding-top: 20px;
    }

    .call-status {
      color: white;
      font-size: 18px;
      margin-bottom: 20px;
    }
    .call-peer-id {
      color: #888;
      font-size: 14px;
      font-family: monospace;
    }

    .call-video-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .remote-video {
      width: 100%;
      max-height: 60vh;
      background: #000;
      border-radius: 12px;
    }

    .local-video {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 150px;
      height: 112px;
      background: #333;
      border-radius: 8px;
      object-fit: cover;
    }

    .audio-only-indicator {
      width: 120px;
      height: 120px;
      background: #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .audio-only-indicator svg {
      width: 60px;
      height: 60px;
      fill: #4a90d9;
    }

    .call-controls {
      display: flex;
      gap: 16px;
      margin-top: 20px;
    }
    .call-controls button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
    }
    .call-controls button:hover { transform: scale(1.1); }
    .call-controls button.mute {
      background: #555;
    }
    .call-controls button.mute.active {
      background: #e74c3c;
    }
    .call-controls button.mute svg { fill: white; width: 24px; height: 24px; }
    .call-controls button.hangup {
      background: #e74c3c;
    }
    .call-controls button.hangup svg { fill: white; width: 24px; height: 24px; }

    /* 来电提示 */
    .incoming-call-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 2000;
      display: none;
      flex-direction: column;
      align-items: center;
      min-width: 280px;
    }
    .incoming-call-modal.active { display: flex; }
    .incoming-call-modal h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    .incoming-call-modal .caller-id {
      font-family: monospace;
      color: #666;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .incoming-call-modal .call-type {
      color: #4a90d9;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .incoming-call-actions {
      display: flex;
      gap: 20px;
    }
    .incoming-call-actions button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .incoming-call-actions button.accept {
      background: #27ae60;
    }
    .incoming-call-actions button.accept svg { fill: white; width: 28px; height: 28px; }
    .incoming-call-actions button.reject {
      background: #e74c3c;
    }
    .incoming-call-actions button.reject svg { fill: white; width: 28px; height: 28px; }

    .overlay-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1999;
      display: none;
    }
    .overlay-bg.active { display: block; }

    /* ============== 响应式适配 ============== */

    /* 返回按钮（默认隐藏，手机端显示） */
    .back-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      margin-right: 8px;
    }
    .back-btn svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    /* 手机端适配（< 768px） */
    @media (max-width: 767px) {
      .header {
        padding: 10px 12px;
      }
      .header > div:first-child {
        display: flex;
        align-items: center;
      }
      .back-btn {
        display: block;
      }
      .header .my-id {
        font-size: 11px;
      }
      .header .my-id span {
        font-size: 10px;
        padding: 2px 6px;
      }

      .main {
        position: relative;
      }

      /* 侧边栏在手机端默认隐藏，占满屏幕 */
      .sidebar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.active {
        transform: translateX(0);
      }

      /* 聊天区域占满 */
      .chat-area {
        width: 100%;
      }

      .chat-header {
        padding: 12px;
        font-size: 13px;
        display: flex;
        align-items: center;
      }
      .chat-header > span {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .messages {
        padding: 12px;
      }
      .message > div {
        max-width: 85%;
      }
      .message .bubble {
        padding: 8px 12px;
        font-size: 14px;
      }

      .input-area {
        padding: 10px 12px;
      }
      .input-area input {
        padding: 10px;
        font-size: 16px; /* 防止 iOS 缩放 */
      }
      .input-area button {
        padding: 10px 16px;
        font-size: 14px;
      }

      /* 通话按钮增大触摸区域 */
      .call-btn {
        padding: 10px;
      }
      .call-btn svg {
        width: 24px;
        height: 24px;
      }

      /* 通话界面适配 */
      .call-overlay.connected {
        padding-top: 10px;
      }
      .remote-video {
        max-height: 50vh;
        border-radius: 8px;
      }
      .local-video {
        width: 100px;
        height: 75px;
        bottom: 10px;
        right: 10px;
        border-radius: 6px;
      }
      .call-controls {
        margin-top: 15px;
        gap: 20px;
      }
      .call-controls button {
        width: 56px;
        height: 56px;
      }

      /* 来电模态框适配 */
      .incoming-call-modal {
        width: 90%;
        max-width: 320px;
        padding: 24px 20px;
      }
      .incoming-call-actions button {
        width: 64px;
        height: 64px;
      }

      /* 状态栏 */
      .status {
        font-size: 11px;
        padding: 6px 12px;
      }

      /* 联系人项 */
      .contact-item {
        padding: 12px 14px;
      }
      .contact-item .delete-btn {
        opacity: 1;
        pointer-events: auto;
      }
    }

    /* 平板适配（768px - 1024px） */
    @media (min-width: 768px) and (max-width: 1024px) {
      .sidebar {
        width: 220px;
      }
      .local-video {
        width: 120px;
        height: 90px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="font-size: 18px; font-weight: 500; display: flex; align-items: center;">
      <button class="back-btn" id="backBtn" title="Back to contacts">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      P2P Chat
    </div>
    <div class="my-id">My ID: <span id="myPeerId" title="Click to copy">Loading...</span></div>
  </div>
  <div id="status" class="status">Connecting...</div>
  <div class="main">
    <div class="sidebar">
      <div class="add-contact">
        <input type="text" id="newPeerId" placeholder="Enter peer ID to chat...">
      </div>
      <div class="contact-list" id="contactList"></div>
    </div>
    <div class="chat-area" id="chatArea">
      <div class="empty-state">Select a contact to start chatting</div>
    </div>
  </div>

  <!-- 通话界面 -->
  <div class="call-overlay" id="callOverlay">
    <div class="call-video-container">
      <div class="call-status" id="callStatus">Calling...</div>
      <div class="call-peer-id" id="callPeerId"></div>

      <!-- 视频通话时显示 -->
      <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
      <video class="local-video" id="localVideo" autoplay playsinline muted></video>

      <!-- 语音通话时显示 -->
      <div class="audio-only-indicator" id="audioOnlyIndicator" style="display:none;">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
      </div>

      <div class="call-controls">
        <button class="mute" id="muteBtn" title="Mute">
          <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
        </button>
        <button class="hangup" id="hangupBtn" title="Hang Up">
          <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- 来电提示 -->
  <div class="overlay-bg" id="overlayBg"></div>
  <div class="incoming-call-modal" id="incomingCallModal">
    <h3>Incoming Call</h3>
    <div class="caller-id" id="callerId"></div>
    <div class="call-type" id="callType">Voice Call</div>
    <div class="incoming-call-actions">
      <button class="reject" id="rejectCallBtn" title="Reject">
        <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
      </button>
      <button class="accept" id="acceptCallBtn" title="Accept">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
      </button>
    </div>
  </div>

  <script type="module" src="./chat.js"></script>
</body>
</html>
